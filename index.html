<!DOCTYPE html>
<html>
<head>
    <title>ツムツム風・完成形</title>
    <style>
        body { text-align: center; background: #222; color: white; margin: 0; overflow: hidden; font-family: sans-serif; }
        canvas { background: #fff; box-shadow: 0 0 30px rgba(255,255,255,0.3); }
        .info { position: absolute; top: 10px; width: 100%; pointer-events: none; }
        #score { font-size: 40px; color: #ffdd5e; text-shadow: 2px 2px 4px #000; }
    </style>
</head>
<body>
    <div class="info">
        <div id="score">SCORE: 0</div>
        <p>マウスでなぞって消そう！</p>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        const { Engine, Render, Runner, Bodies, Composite, Events, MouseConstraint, Mouse } = Matter;
        const engine = Engine.create();
        const render = Render.create({
            element: document.body,
            engine: engine,
            options: { width: 400, height: 600, wireframes: false, background: '#111' }
        });

        // 枠の作成
        const ground = Bodies.rectangle(200, 590, 400, 20, { isStatic: true, render: { fillStyle: '#333' } });
        const leftWall = Bodies.rectangle(5, 300, 10, 600, { isStatic: true, render: { fillStyle: '#333' } });
        const rightWall = Bodies.rectangle(395, 300, 10, 600, { isStatic: true, render: { fillStyle: '#333' } });
        Composite.add(engine.world, [ground, leftWall, rightWall]);

        const colors = ['#FF5E5E', '#FFDD5E', '#5EFF8E', '#5E96FF', '#DF5EFF'];
        let score = 0;

        function createTsumu(x, y) {
            const color = colors[Math.floor(Math.random() * colors.length)];
            return Bodies.circle(x, y, 25, {
                restitution: 0.4,
                friction: 0.1,
                render: { fillStyle: color },
                label: color
            });
        }

        for(let i=0; i<40; i++) {
            Composite.add(engine.world, createTsumu(100 + Math.random()*200, -500 * Math.random()));
        }

        // マウス設定（逃げないように修正）
        const mouse = Mouse.create(render.canvas);
        const mouseConstraint = MouseConstraint.create(engine, {
            mouse: mouse,
            constraint: { stiffness: 0, render: { visible: false } }
        });
        mouseConstraint.collisionFilter.mask = 0; // ツムを物理的に掴まないようにする
        Composite.add(engine.world, mouseConstraint);

        let selectedBalls = [];
        Events.on(mouseConstraint, "mousemove", () => {
            if (mouseConstraint.mouse.button === 0) {
                const found = Matter.Query.point(Composite.allBodies(engine.world), mouse.position)[0];
                if (found && !found.isStatic) {
                    if (selectedBalls.length === 0 || (selectedBalls[0].label === found.label && !selectedBalls.includes(found))) {
                        // 距離が近い場合だけ追加（遠くのツムを飛ばさないように）
                        if (selectedBalls.length > 0) {
                            const last = selectedBalls[selectedBalls.length-1];
                            const dist = Math.sqrt(Math.pow(last.position.x - found.position.x, 2) + Math.pow(last.position.y - found.position.y, 2));
                            if (dist > 70) return; 
                        }
                        selectedBalls.push(found);
                        found.render.opacity = 0.5;
                    }
                }
            }
        });

        Events.on(mouseConstraint, "mouseup", () => {
            if (selectedBalls.length >= 3) {
                score += selectedBalls.length * 100;
                document.getElementById('score').innerText = `SCORE: ${score}`;
                selectedBalls.forEach(ball => {
                    Composite.remove(engine.world, ball);
                    setTimeout(() => {
                        Composite.add(engine.world, createTsumu(100 + Math.random()*200, -50));
                    }, 500);
                });
            } else {
                selectedBalls.forEach(ball => ball.render.opacity = 1);
            }
            selectedBalls = [];
        });

        Render.run(render);
        Runner.run(Runner.create(), engine);
    </script>
</body>
</html>